---
import { getCollection, type CollectionEntry } from 'astro:content';
import type { Page } from "astro";

import { ITEMS_PER_PAGE } from "@/consts";
import { excludeDrafts, sortBlogPosts } from "@/functions";
import ListLayout from '@/layouts/ListLayout.astro';

interface Props {
    page: Page<CollectionEntry<'blog'>>;
    entry: CollectionEntry<'tags'>;
}

export async function getStaticPaths({ paginate }: { paginate: Function }) {
    const tags = await getCollection('tags');
    const posts = await getCollection('blog', excludeDrafts).then(sortBlogPosts);

    return tags.flatMap(entry => {
        const tagPosts = posts.filter(post => post.data.tags.some((tag) => tag.id === entry.slug));
        return paginate(tagPosts, {pageSize: ITEMS_PER_PAGE, params: {slug: entry.slug}, props: {entry}});
    });
}

const {page, entry} = Astro.props;
const {Content} = await entry.render()

let robots = null;
if (page.currentPage > 1) {
    // Ask search engines to not index paginated pages
    robots = "noindex, follow";
}
---

<ListLayout title={entry.data.name} description={entry.data.description ?? ""} page={page} robots={robots ?? undefined}>
    <Content/>
</ListWithTagsLayout>
